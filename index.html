<script>
    document.addEventListener("DOMContentLoaded", function () {
        const connectButton = document.getElementById("connectWallet");
        if (!connectButton) {
            console.error("connectWallet ボタンが見つかりません");
            return;
        }

        connectButton.addEventListener("click", async function () {
            console.log("ウォレット接続ボタンが押されました");

            if (!window.solana || !window.solana.isPhantom) {
                alert("Phantomウォレットがインストールされていません。");
                return;
            }

            try {
                const response = await window.solana.connect({ onlyIfTrusted: false });
                console.log("Connected:", response.publicKey.toString());
                document.getElementById("walletAddress").textContent = `ウォレット: ${response.publicKey.toString()}`;

                // Solanaの接続設定
                const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");

                // SOL 残高取得
                try {
                    const solBalance = await connection.getBalance(new solanaWeb3.PublicKey(response.publicKey.toString()));
                    document.getElementById("solBalance").textContent = `SOL 残高: ${(solBalance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4)} SOL`;
                } catch (solError) {
                    console.error("SOL残高取得エラー:", solError.message);
                    document.getElementById("solBalance").textContent = "SOL 残高: エラー";
                }

                // GRI トークン残高取得
                const GRI_TOKEN_MINT_ADDRESS = "Va7yuUnSYdg23QjHjPAc9fkBrK3oD4mr3Ee52vFcyev";
                try {
                    const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                        new solanaWeb3.PublicKey(response.publicKey.toString()),
                        { programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
                    );

                    let griBalance = 0;
                    tokenAccounts.value.forEach(account => {
                        const mint = account.account.data.parsed.info.mint;
                        if (mint === GRI_TOKEN_MINT_ADDRESS) {
                            griBalance = account.account.data.parsed.info.tokenAmount.uiAmount;
                        }
                    });

                    document.getElementById("griBalance").textContent = `GRI 残高: ${griBalance} GRI`;

                } catch (griError) {
                    console.error("GRIトークン取得エラー:", griError.message);
                    document.getElementById("griBalance").textContent = "GRI 残高: エラー";
                }

            } catch (error) {
                console.error("ウォレット接続エラー:", error.message);
                alert(`ウォレット接続に失敗しました: ${error.message}`);
            }
        });
    });
</script>
